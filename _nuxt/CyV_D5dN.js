import{a2 as F,K as j,G as v,N as C,a4 as U,r as I}from"./BrVuSVAX.js";import{u as G}from"./BJD3ubJj.js";const R=(i,t="Bearer")=>{if(!i)return null;const d=String(i).trim();if(!d)return null;const c=d.match(/^(Bearer|Token)\s+(.+)$/i);if(c){const y=c[1].toLowerCase()==="bearer"?"Bearer":"Token",b=String(c[2]??"").trim();return b?`${y} ${b}`:null}return`${String(t||"Token").toLowerCase()==="bearer"?"Bearer":"Token"} ${d}`},x=i=>{if(!i)return null;const t=String(i).trim();if(!t)return null;const d=t.match(/^(Bearer|Token)\s+(.+)$/i);return d?String(d[2]??"").trim():t},T=i=>{const t=i?.key;return typeof t=="string"&&t.toLowerCase()==="unauthenticated"},W=()=>{const{baseURL:i}=F(),t=j(),d=v(),c=async(r,h={})=>{const{method:g="GET",body:B,query:l,headers:e={},auth:n=!0,responseType:w="json",parseResponse:u,authScheme:p="Bearer",onRequest:A,onResponse:P,onError:z}=h;try{n&&!t.isAuthenticated&&t.initAuth();const s={Accept:"application/json","Content-Type":"application/json","Cache-Control":"no-cache",Pragma:"no-cache",...e},m=n?t.getToken:null;if(n&&m){const a=R(m,p);a&&(s.Authorization=a)}const f=r.startsWith("http")?r:`${i}${r}`,S={method:g,headers:s,body:B,query:l,responseType:w};u?S.parseResponse=u:w==="json"&&(S.parseResponse=a=>{try{return JSON.parse(a)}catch(q){return console.error("Failed to parse JSON response:",q),a}}),A&&A({options:S}),console.log("Making API request to:",f),console.log("Request options:",{method:S.method,hasAuth:!!s.Authorization,headers:{...s,...s.Authorization?{Authorization:`${String(s.Authorization).split(" ")[0]} ***`}:{}}});let o=await $fetch(f,S);if(w==="json"&&typeof Blob<"u"&&o instanceof Blob){const a=await o.text();try{o=JSON.parse(a)}catch(q){console.error("Failed to parse JSON Blob response:",q),o=a}}if(console.log("API Response received from:",f),console.log("Response:",o),console.log("Response type:",typeof o),n&&m&&w==="json"&&T(o)){const a=x(m),q=[R(m,p),a?R(a,p):null,a?R(a,"Bearer"):null,a?R(a,"Token"):null,a?String(a):null].filter(Boolean),D=new Set,H=q.filter($=>D.has($)?!1:(D.add($),!0));for(let $=0;$<H.length;$++){const O=H[$];if(O===s.Authorization)continue;console.warn(`API returned unauthenticated; retrying with Authorization variant #${$+1}:`,String(O).split(" ")[0],"***");const _={...s,Authorization:O},J={...S,headers:_};if(o=await $fetch(f,J),typeof Blob<"u"&&o instanceof Blob){const L=await o.text();try{o=JSON.parse(L)}catch(M){console.error("Failed to parse JSON Blob response (retry):",M),o=L}}if(!T(o))break}T(o)&&(console.error("API still unauthenticated after retries; clearing auth and redirecting to login."),t.clearAuth(),await C(d("/auth/login")))}if(P&&P({response:o}),o?.key==="fail"||o?.status===!1){const a=o?.msg||o?.message||"Request failed";throw new Error(a)}return o}catch(s){(s?.response?.status===401||s?.statusCode===401)&&(t.clearAuth(),await C(d("/auth/login"))),z&&z({error:s});const m=s?.data?.msg||s?.data?.message||s?.message||"An error occurred";throw console.error("API Error:",m,s),{success:!1,error:m,originalError:s}}};return{api:c,get:(r,h={})=>c(r,{...h,method:"GET"}),post:(r,h,g={})=>c(r,{...g,method:"POST",body:h}),put:(r,h,g={})=>c(r,{...g,method:"PUT",body:h}),patch:(r,h,g={})=>c(r,{...g,method:"PATCH",body:h}),delete:(r,h={})=>c(r,{...h,method:"DELETE"})}},Y=(i,t={})=>{const{baseURL:d}=F(),c=j(),k=v(),y=t.auth!==!1,b=t.authScheme||"Bearer",N=t.strictAuth===!0,E=I(b),r=I(0),h=1;let g;const l={...{baseURL:d,key:i,getCachedData:e=>{},onRequest({options:e}){let n=c.getToken;console.log("â•â•â• useApiFetch - onRequest START â•â•â•"),console.log("Endpoint:",i),console.log("Full URL:",`${d}${i}`),console.log("Has Token:",!!n),console.log("Token (first 20 chars):",n?n.substring(0,20)+"...":"NONE"),console.log("Is Authenticated:",c.isAuthenticated),console.log("User:",c.user?.name||"No user"),console.log("â•â•â• useApiFetch - onRequest END â•â•â•");const w={Accept:"application/json, text/plain, */*","Cache-Control":"no-cache",Pragma:"no-cache"};if(y)if(n){const u=R(n,E.value);u&&(w.Authorization=u,console.log("Authorization header set:",`${String(u).split(" ")[0]} ${String(x(u)).substring(0,20)}...`))}else console.error("âš ï¸ WARNING: No token available for authenticated request!");e.headers=Object.assign({},e.headers,w)},onResponse({response:e}){if(console.log("â•â•â• useApiFetch - onResponse START â•â•â•"),console.log("Endpoint:",i),console.log("Status:",e.status),console.log("Response Data:",e._data),console.log("Response Key:",e._data?.key),console.log("Response Message:",e._data?.msg),console.log("â•â•â• useApiFetch - onResponse END â•â•â•"),e?.status===401)console.error("ðŸš¨ 401 Unauthorized - Clearing auth and redirecting to login"),c.clearAuth(),U(()=>C(k("/auth/login")));else if(T(e._data)){console.warn("âš ï¸ API returned unauthenticated key");const n=e._data;if(!!(n?.data||n?.orders||n?.pagination||n?.items||n&&Object.keys(n).length>2)){console.log("âœ… Response has data despite unauthenticated key - treating as successful");return}if(console.warn("No data in response - attempting retry with different auth scheme"),y&&c.getToken&&r.value<h){r.value+=1,E.value=E.value==="Bearer"?"Token":"Bearer",console.warn(`Retrying with auth scheme: ${E.value} (attempt ${r.value}/${h})`),U(()=>g?.refresh?.());return}N&&y?(console.error("ðŸš¨ Unauthenticated after retries - Clearing auth and redirecting to login"),c.clearAuth(),U(()=>C(k("/auth/login")))):console.warn("Authentication failed but strictAuth=false - not redirecting")}},onResponseError({response:e}){if(console.error("â•â•â• useApiFetch - onResponseError START â•â•â•"),console.error("Endpoint:",i),console.error("Full URL:",`${d}${i}`),console.error("Status:",e?.status),console.error("Status Text:",e?.statusText),console.error("Response Data:",e?._data),console.error("Response Key:",e?._data?.key),console.error("Response Message:",e?._data?.msg),console.error("â•â•â• useApiFetch - onResponseError END â•â•â•"),e?.status===200&&T(e?._data)){console.warn("âš ï¸ 200 Response with unauthenticated key in onResponseError - NOT logging out"),console.warn("This means the API returned HTTP 200 but with error data - NOT a genuine auth failure"),console.warn("Your token might be invalid, expired, or in wrong format. Check the onRequest logs above.");return}e?.status===401&&(console.error("ðŸš¨ 401 Unauthorized Error - Clearing auth and redirecting to login"),c.clearAuth(),U(()=>C(k("/auth/login"))))},parseResponse(e){try{return JSON.parse(e)}catch(n){return console.error("Failed to parse JSON response:",n),e}}},...t};return g=G(i,l,"$GulDXUZHcY"),g},X=()=>{const{baseURL:i}=F(),t=j(),d=v();return{upload:async(k,y,b={})=>{const{method:N="POST",headers:E={},auth:r=!0,onRequest:h,onResponse:g,onError:B}=b;try{const l={Accept:"application/json, text/plain, */*","Cache-Control":"no-cache",Pragma:"no-cache",...E};if(r&&t.getToken){const p=R(t.getToken,"Bearer");p&&(l.Authorization=p)}const e=k.startsWith("http")?k:`${i}${k}`;h&&h({options:{method:N,headers:l,body:y}});let u=await(await fetch(e,{method:N,headers:l,body:y})).json();if(r&&t.getToken&&T(u)){const p=t.getToken,A=x(p),P="Token",z=[R(p,P),A?R(A,P):null,A?R(A,"Bearer"):null,A?R(A,"Token"):null,A?String(A):null].filter(Boolean),s=new Set,m=z.filter(f=>s.has(f)?!1:(s.add(f),!0));for(let f=0;f<m.length;f++){const S=m[f];if(S===l.Authorization)continue;console.warn(`Upload returned unauthenticated; retrying with Authorization variant #${f+1}:`,String(S).split(" ")[0],"***");const o={...l,Authorization:S};if(u=await(await fetch(e,{method:N,headers:o,body:y})).json(),!T(u))break}T(u)&&(console.error("Upload still unauthenticated after retries; clearing auth and redirecting to login."),t.clearAuth(),await C(d("/auth/login")))}if(g&&g({response:u}),u?.key==="fail"||u?.status===!1){const p=u?.msg||u?.message||"Upload failed";throw new Error(p)}return u}catch(l){(l?.response?.status===401||l?.statusCode===401)&&(t.clearAuth(),await C(d("/auth/login"))),B&&B({error:l});const e=l?.data?.msg||l?.data?.message||l?.message||"Upload failed";throw console.error("Upload Error:",e,l),{success:!1,error:e,originalError:l}}}}};export{W as a,Y as b,X as u};
