import{_ as q}from"./BHkXlc2d.js";import{_ as F}from"./Cl8wGDmU.js";import{_ as z,E,K,G as U,g as G,q as Q,c as _,a as s,L as T,C as n,t as u,b as B,F as H,B as J,d as C,M as W,r as m,N as X,O as Y,o as g,P as Z,Q as ee,R as te}from"./CtGyamCA.js";import{u as se,a as oe}from"./NVE8NEWq.js";import{u as ae}from"./CIi_ESSC.js";import{_ as ne}from"./BFLBms6F.js";import{s as re}from"./Bq5Jt91I.js";import"./CbfEzn4B.js";import"./B3LWhJXf.js";import"./DIH-4xJn.js";const le=["dir"],ie={class:"w-full md:w-[50%] relative flex flex-col items-center justify-center p-6 md:p-12 z-10 overflow-y-auto"},ce={class:"mt-12 md:mt-16 w-full text-center mb-10"},ue={class:"hidden md:flex justify-center mb-8"},de=["src"],pe={class:"flex items-center justify-between"},me={class:"text-3xl font-bold text-brand-textDark mb-2"},fe={class:"text-gray-500 text-sm font-medium"},ve={class:"w-full space-y-6"},he={class:"flex gap-4 justify-center",dir:"ltr"},_e=["onUpdate:modelValue","onInput","onKeydown"],ge={class:"text-[#3A2A22]/80 text-sm font-semibold text-center"},ye=["disabled"],xe={key:0,class:"inline-flex items-center justify-center gap-2"},be={key:1},we={class:"mt-6 text-sm text-[#3A2A22]/70 text-center"},ke=["disabled"],De={__name:"otp",setup(Ae){const{t:o,locale:I}=E(),r=K(),O=U(),w=Y(),i=ae(),{upload:j}=se(),{get:$}=oe(),c=m(["","","",""]),v=m([]),h=m(!1),d=m(59);let y=null;const x=m(!1),A=m(!1);G(()=>{r.initAuth?.(),v.value[0]?.focus?.(),L()}),Q(()=>{k()});function L(){k(),y=re(()=>{d.value>0?d.value--:k()},1e3)}function k(){y&&clearInterval(y),y=null}const f=m(!1);async function M(){if(!(f.value||d.value>0)){f.value=!0;try{const t=w.query.phone;if(!t){i.error(o("auth.otp.errors.missingPhone","رقم الجوال غير متوفر"));return}const e=await $(`/resend-code?phone=${t}`,{auth:!0});i.success(e?.msg||e?.message||o("auth.otp.resendSuccess","تم إعادة إرسال الكود بنجاح")),d.value=59,c.value=["","","",""],v.value[0]?.focus(),L()}catch(t){i.error(t?.error||t?.message||o("auth.otp.resendFailed","فشل إعادة إرسال الكود"))}finally{f.value=!1}}}function N(t){const e=c.value[t].replace(/[^0-9]/g,"");c.value[t]=e,e&&t<3&&v.value[t+1]?.focus()}function P(t){!c.value[t]&&t>0&&v.value[t-1]?.focus()}async function R(){if(h.value)return;const t=c.value.join("").trim();if(t.length!==c.value.length){i.error(o("auth.otp.errors.completeCode","الرجاء إدخال رمز التحقق كاملاً")),S();return}h.value=!0;try{const e=new FormData;e.append("device_type",r.getDeviceType()),e.append("device_id",r.getDeviceId()),e.append("code",t),e.append("activation_code",t),w.query.phone&&e.append("phone",w.query.phone);const a=await j("/activate?_method=patch",e,{method:"POST",auth:!0});i.success(a?.msg||a?.message||o("auth.otp.success","تم تفعيل الحساب بنجاح"));const l=a?.data?.token??a?.token??a?.data?.access_token??a?.access_token,b=typeof l=="string"?l.trim():l,p=a?.data?.user??a?.data??r.user;b&&r.setAuth(b,p),x.value=!0}catch(e){i.error(e?.error||e?.message||o("auth.otp.errors.failed","فشل تفعيل الحساب")),S()}finally{h.value=!1}}async function V({lat:t,lng:e,address:a}){x.value=!1,A.value=!0;try{const l=await r.updateProfile({name:r.user?.name,email:r.user?.email,city_id:r.user?.city?.id||r.user?.city_id,lat:t,lng:e,map_desc:a});l.success?(i.success(o("auth.location.success","تم حفظ الموقع بنجاح")),await X(O("/"))):i.error(l.error||o("auth.location.failed","فشل حفظ الموقع"))}catch(l){i.error(l?.message||o("auth.location.error","حدث خطأ أثناء حفظ الموقع"))}finally{A.value=!1}}function S(){document.querySelectorAll(".otp-box").forEach(e=>{e.classList.add("shake"),setTimeout(()=>e.classList.remove("shake"),350)})}return(t,e)=>{const a=q,l=F;return g(),_("div",{class:"h-screen w-full flex flex-col md:flex-row",dir:n(I)==="ar"?"rtl":"ltr"},[e[3]||(e[3]=s("div",{class:"hidden h-screen md:flex flex-1 radial-gradient-subtle items-center justify-center p-12 relative overflow-hidden"},[s("div",{class:"text-center z-10"},[s("img",{src:T,alt:"logo",class:"w-56 h-48 mx-auto"})])],-1)),s("div",ie,[e[2]||(e[2]=s("div",{class:"mb-8 md:hidden"},[s("img",{src:T,alt:"logo",class:"w-24 h-20"})],-1)),s("div",ce,[s("div",ue,[s("img",{src:n(ne),alt:"icon",class:"w-24 h-20"},null,8,de)]),s("div",pe,[s("div",null,[s("h2",me,u(n(o)("auth.otp.title","كود التحقق")),1),s("p",fe,u(n(o)("auth.otp.subtitle","قم بإدخال الكود المرسل على رقم جوالك")),1)]),B(a,{variant:"auth",size:"sm"})])]),s("div",ve,[s("div",he,[(g(!0),_(H,null,J(c.value,(b,p)=>Z((g(),_("input",{key:p,ref_for:!0,ref_key:"otpRefs",ref:v,"onUpdate:modelValue":D=>c.value[p]=D,maxlength:"1",inputmode:"numeric",class:"otp-box w-14 h-14 rounded-xl border-none bg-[#E9DCD6]/80 text-[#3A2A22] text-2xl font-bold text-center focus:outline-none focus:ring-2 focus:ring-[#B54628]/30 shadow-sm transition-all",onInput:D=>N(p),onKeydown:te(D=>P(p),["backspace"])},null,40,_e)),[[ee,c.value[p]]])),128))]),s("div",ge,u(n(o)("auth.otp.remainingTime","الوقت المتبقي"))+" : "+u(d.value)+" "+u(n(o)("common.seconds","ثانية")),1),s("button",{onClick:R,disabled:h.value,class:"w-full !py-4 back-btn transition transform hover:-translate-y-1 mt-4 disabled:opacity-50 disabled:cursor-not-allowed"},[h.value?(g(),_("span",xe,[e[1]||(e[1]=s("span",{class:"inline-block w-5 h-5 rounded-full border-2 border-white/40 border-t-white animate-spin"},null,-1)),C(" "+u(n(o)("auth.otp.verifying","جاري التحقق...")),1)])):(g(),_("span",be,u(n(o)("auth.otp.verify","تحقق")),1))],8,ye),s("div",we,[C(u(n(o)("auth.otp.didNotReceive","لم تستلم الرمز؟"))+" ",1),s("button",{onClick:M,disabled:f.value||d.value>0,class:W(["font-bold hover:underline cursor-pointer mx-1 transition-colors",f.value||d.value>0?"text-gray-400 cursor-not-allowed no-underline":"text-[#B54628]"])},u(f.value?n(o)("common.sending","جاري الإرسال..."):n(o)("auth.otp.resend","إعادة الإرسال")),11,ke)])])]),B(l,{isOpen:x.value,onClose:e[0]||(e[0]=b=>x.value=!1),onLocationSelected:V},null,8,["isOpen"])],8,le)}}},Ne=z(De,[["__scopeId","data-v-a70792e9"]]);export{Ne as default};
