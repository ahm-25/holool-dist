import Z from"./C2WZtiU1.js";import{c as d,o as c,J as S,a as t,t as h,M as I,v as ee,F as j,B as O,b as E,K as se,E as te,r as f,g as R,k as ae,N as re,n as oe,A as q,O as le,P as ne,Q as ie,S as ce,a1 as de}from"./c72oGId3.js";import{a as ue,u as me}from"./DACiwXMA.js";import{u as fe}from"./C_Rn6DEZ.js";import"./CzzcvkpU.js";const he={key:0,class:"flex-shrink-0"},ve=["src"],ge={key:0,class:"mb-3 overflow-hidden rounded-xl"},pe=["src"],ye={key:1,class:"text-sm md:text-base leading-relaxed font-medium"},be={__name:"MessageBubble",props:{message:{type:Object,required:!0},senderAvatar:{type:String,default:""}},setup(i){return(g,w)=>(c(),d("div",{class:I(["flex w-full mb-4 items-end gap-2",i.message.isMe?"justify-end":"justify-start"])},[i.message.isMe?S("",!0):(c(),d("div",he,[t("img",{src:i.senderAvatar,class:"w-8 h-8 rounded-full object-cover border border-white/30 shadow-sm",alt:"Sender"},null,8,ve)])),t("div",{class:I(["relative max-w-[75%] md:max-w-[60%] px-5 py-3 shadow-sm",i.message.isMe?"bg-[#8f8f8f] text-white rounded-2xl rounded-bl-none":"bg-[#e6dcd5]/80 backdrop-blur-sm text-clay-900 rounded-2xl rounded-br-none"])},[i.message.imageUrl?(c(),d("div",ge,[t("img",{src:i.message.imageUrl,class:"w-full h-auto object-cover max-h-64"},null,8,pe)])):S("",!0),i.message.text?(c(),d("p",ye,h(i.message.text),1)):S("",!0)],2)],2))}},_e=["src","alt"],L={__name:"Avatar",props:{src:String,alt:String,size:{type:String,default:"md"},className:{type:String,default:""}},setup(i){const g=ee({sm:"w-10 h-10",md:"w-12 h-12",lg:"w-14 h-14"});return(w,m)=>(c(),d("div",{class:I(["relative inline-block",g[i.size],i.className])},[t("img",{src:i.src,alt:i.alt,class:"w-full h-full rounded-full object-cover border-2 border-clay-100/50 shadow-sm"},null,8,_e)],2))}},xe={class:"flex flex-col gap-3 overflow-y-auto pr-2 pb-2 h-full"},we=["onClick"],ke={class:"flex w-full items-center gap-3"},Ae={class:"flex flex-col items-start flex-1 min-w-0"},Me={class:"font-bold text-clay-900 truncate text-right w-full text-base"},$e={class:"text-xs text-clay-700/80 truncate text-right w-full font-medium mt-0.5"},Re={__name:"ChatList",props:{users:Array,activeUserId:String,onSelectUser:Function},setup(i){return(g,w)=>(c(),d("div",xe,[(c(!0),d(j,null,O(i.users,m=>(c(),d("button",{key:m.id,onClick:()=>i.onSelectUser(m.id),class:I(["group flex items-center p-3 rounded-2xl transition-all duration-200 border",m.id===i.activeUserId?"bg-clay-200/80 shadow-inner border-clay-400/30":"bg-clay-100/30 hover:bg-clay-100/50 border-transparent hover:border-white/20"])},[t("div",ke,[E(L,{src:m.avatar,alt:m.name,size:"md"},null,8,["src","alt"]),t("div",Ae,[t("span",Me,h(m.name),1),t("span",$e,h(m.lastMessage||"Click to chat"),1)])])],10,we))),128))]))}},Se=()=>{const{get:i}=ue(),{upload:g}=me(),w=async()=>{try{return await i("/get-rooms")}catch(l){throw console.error("Error fetching rooms:",l),l}},m=async l=>{try{return await i(`/room-members/${l}`)}catch(o){throw console.error("Error fetching room members:",o),o}},A=async l=>{try{return await i(`/get-room-messages/${l}`)}catch(o){throw console.error("Error fetching room messages:",o),o}},x=async(l,o)=>{try{const n=new FormData;return n.append("message",o),await g(`/send-message/${l}`,n)}catch(n){throw console.error("Error sending message:",n),n}},M=async(l,o)=>{try{const n=new FormData;return n.append("file",o),await g(`/upload-room-file/${l}`,n)}catch(n){throw console.error("Error uploading file:",n),n}};return{getRooms:w,getRoomMembers:m,getRoomMessages:A,sendMessage:x,uploadRoomFile:M,sendMessageWithFile:async(l,o,n)=>{try{const y=await M(l,n),v=await x(l,o);return{file:y,message:v}}catch(y){throw console.error("Error sending message with file:",y),y}}}},Ee={class:"min-h-screen h-screen p-4 md:p-6 flex items-center justify-center bg-[#d4beb1]",dir:"rtl"},Ie={class:"w-full max-w-[1400px] h-full max-h-[850px] grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-6"},Ce={class:"hidden lg:flex flex-col bg-clay-200/20 backdrop-blur-md border border-white/20 rounded-[2rem] shadow-sm p-4 h-full overflow-hidden"},Fe={key:0,class:"flex items-center justify-center h-full"},je={class:"text-clay-700"},Ue={key:1,class:"flex items-center justify-center h-full"},De={class:"text-clay-700 text-center"},Be={class:"relative bg-clay-200/20 backdrop-blur-md border border-white/20 rounded-[2rem] shadow-sm flex flex-col overflow-hidden"},ze={class:"p-6 flex items-center z-10 border-b border-white/10"},Ne={key:0,class:"flex items-center gap-3"},Te={class:"text-right"},Ve={class:"text-xl font-bold text-clay-900"},Ke={key:1,class:"flex items-center gap-3"},qe={class:"text-right"},Oe={class:"text-xl font-bold text-clay-900"},Le={class:"flex-1 overflow-y-auto p-4 md:p-8 space-y-2 custom-scrollbar"},Pe={key:0,class:"flex items-center justify-center h-full"},We={class:"text-clay-700"},He={key:1,class:"flex items-center justify-center h-full"},Je={class:"text-clay-700 text-center"},Qe={key:2,class:"flex items-center justify-center h-full"},Ge={class:"text-clay-700 text-center"},Xe={class:"text-sm mt-2"},Ye={key:0,class:"flex w-full justify-start mb-4 px-12"},Ze={class:"p-4 md:p-6 pt-2"},es={class:"bg-clay-100/40 backdrop-blur-xl rounded-2xl p-2 px-3 flex items-center gap-3 shadow-sm border border-white/30"},ss=["onKeydown","placeholder","disabled"],ts=["disabled","title"],as=["disabled","title"],cs={__name:"index",setup(i){const{getRooms:g,getRoomMessages:w,sendMessage:m}=Se(),A=se(),x=fe(),M=re(),{t:p}=te(),l=f([]),o=f(null),n=f([]),y=f([]),v=f(""),P=f(!1),U=f(null),C=f(!1),F=f(!1),D=f(null),W=f(null),$=R(()=>!Array.isArray(l.value)||l.value.length===0?null:l.value.find(e=>e.id==o.value)||l.value[0]),k=R(()=>$.value?{id:$.value.id,name:$.value.name,avatar:$.value.avatar}:null),B=R(()=>Array.isArray(l.value)?l.value:[]),z=R(()=>n.value.map(e=>({id:e.id,senderId:e.sender_id||e.user_id||e.senderId,text:e.body||e.message||e.text||"",timestamp:e.created_dt||e.created_at||"",imageUrl:e.image_url||e.imageUrl,isMe:e.isMe||e.is_sender===1||e.is_sender===!0})));ae(async()=>{await H();const e=M.query.roomId;if(e){const s=l.value.find(u=>u.id==e);s?o.value=s.id:o.value=Number(e)||e}else l.value.length>0&&(o.value=l.value[0].id);o.value&&await N(o.value)});const H=async()=>{var e;try{C.value=!0;const s=await g();console.log("API Response for getRooms:",s),console.log("Response type:",typeof s),console.log("Is Array:",Array.isArray(s));let u=[];Array.isArray(s)?u=s:(e=s==null?void 0:s.data)!=null&&e.data&&Array.isArray(s.data.data)?u=s.data.data:s!=null&&s.data&&Array.isArray(s.data)?u=s.data:s!=null&&s.rooms&&Array.isArray(s.rooms)&&(u=s.rooms),l.value=u.map(a=>{var V,K;if(a.providerable)return{id:a.providerable.room_id||a.id,originalId:a.id,name:a.providerable.name||p("profile.chat.user"),avatar:a.providerable.image||"https://picsum.photos/id/64/200",lastMessage:a.notes||a.status_text||p("profile.chat.noMessages"),members:[{id:"other",name:a.providerable.name,avatar:a.providerable.image}],...a};const r=(V=A.user)==null?void 0:V.id,b=a.members||[],_=b.find(Y=>Y.id!==r)||b[0];return{id:a.id,name:a.name||(_==null?void 0:_.name)||p("profile.chat.title"),avatar:a.avatar||(_==null?void 0:_.image)||"https://picsum.photos/id/64/200",lastMessage:a.last_message_body||((K=a.last_message)==null?void 0:K.text)||a.lastMessage||"",lastMessageTime:a.last_message_created_dt||"",members:b,...a}}),console.log("Rooms set to:",l.value),console.log("Rooms count:",l.value.length)}catch(s){console.error("Error fetching rooms:",s),x.error(p("profile.chat.loadError")),l.value=[]}finally{C.value=!1}},N=async e=>{var s,u,a;if(e)try{F.value=!0;const r=await w(e);(s=r==null?void 0:r.data)!=null&&s.members&&Array.isArray(r.data.members)&&(y.value=r.data.members),(a=(u=r==null?void 0:r.data)==null?void 0:u.messages)!=null&&a.data&&Array.isArray(r.data.messages.data)?n.value=r.data.messages.data.slice().reverse():Array.isArray(r==null?void 0:r.data)?n.value=r.data.slice().reverse():Array.isArray(r)?n.value=r.slice().reverse():n.value=[]}catch(r){console.error("Error fetching messages:",r),x.error(p("profile.chat.loadMessagesError")),n.value=[]}finally{F.value=!1}},J=async e=>{o.value!==e&&(o.value=e,await N(e))},Q=()=>{v.value.trim()&&T()},T=async()=>{var u,a;if(!v.value.trim()||!o.value)return;const e=v.value,s={id:"temp-"+Date.now(),user_id:(u=A.user)==null?void 0:u.id,message:e,created_at:new Date().toISOString(),isMe:!0};n.value.push(s),v.value="";try{const r=await m(o.value,e);if((a=r==null?void 0:r.data)!=null&&a.id){const b=n.value.findIndex(_=>_.id===s.id);b!==-1&&n.value.splice(b,1,r.data)}}catch(r){console.error("Error sending message:",r),x.error(p("profile.chat.sendError")),n.value=n.value.filter(b=>b.id!==s.id)}},G=e=>{const s=e.target.files[0];s&&(W.value=s,x.success(`${p("profile.chat.fileSelected")}${s.name}`))},X=()=>{var e;(e=D.value)==null||e.click()};return oe(n,()=>{de(()=>{var e;(e=U.value)==null||e.scrollIntoView({behavior:"smooth"})})},{deep:!0}),(e,s)=>{const u=Z;return c(),d("div",Ee,[t("div",Ie,[t("div",Ce,[C.value?(c(),d("div",Fe,[t("div",je,h(e.$t("common.loading")),1)])):B.value.length===0?(c(),d("div",Ue,[t("div",De,[t("p",null,h(e.$t("profile.chat.noChats")),1)])])):(c(),q(Re,{key:2,users:B.value,activeUserId:o.value,onSelectUser:J},null,8,["users","activeUserId"]))]),t("div",Be,[t("div",ze,[k.value?(c(),d("div",Ne,[E(L,{src:k.value.avatar,alt:k.value.name,size:"lg"},null,8,["src","alt"]),t("div",Te,[t("h2",Ve,h(k.value.name),1)])])):(c(),d("div",Ke,[t("div",qe,[t("h2",Oe,h(e.$t("profile.chat.title")),1)])]))]),t("div",Le,[F.value?(c(),d("div",Pe,[t("div",We,h(e.$t("profile.chat.loadingMessages")),1)])):o.value?z.value.length===0?(c(),d("div",Qe,[t("div",Ge,[t("p",null,h(e.$t("profile.chat.noMessages")),1),t("p",Xe,h(e.$t("profile.chat.startConversation")),1)])])):(c(),d(j,{key:3},[(c(!0),d(j,null,O(z.value,a=>{var r;return c(),q(be,{key:a.id,message:a,senderAvatar:((r=k.value)==null?void 0:r.avatar)||"https://picsum.photos/id/64/200"},null,8,["message","senderAvatar"])}),128)),P.value?(c(),d("div",Ye,s[1]||(s[1]=[t("div",{class:"bg-[#e6dcd5]/80 text-clay-900 rounded-2xl p-3 shadow-sm flex items-center gap-1"},[t("span",{class:"w-1.5 h-1.5 bg-clay-800/40 rounded-full animate-bounce"}),t("span",{class:"w-1.5 h-1.5 bg-clay-800/40 rounded-full animate-bounce delay-75"}),t("span",{class:"w-1.5 h-1.5 bg-clay-800/40 rounded-full animate-bounce delay-150"})],-1)]))):S("",!0)],64)):(c(),d("div",He,[t("div",Je,[t("p",null,h(e.$t("profile.chat.selectConversation")),1)])])),t("div",{ref_key:"messagesEndRef",ref:U},null,512)]),t("div",Ze,[t("input",{ref_key:"fileInput",ref:D,type:"file",class:"hidden",onChange:G,accept:"image/*,video/*,.pdf,.doc,.docx"},null,544),t("div",es,[le(t("input",{"onUpdate:modelValue":s[0]||(s[0]=a=>v.value=a),onKeydown:ie(ce(Q,["prevent"]),["enter"]),placeholder:e.$t("profile.chat.typeHere"),disabled:!o.value,class:"flex-1 bg-transparent border-none outline-none px-4 text-clay-900 placeholder-clay-700/50 text-right font-medium disabled:opacity-50 disabled:cursor-not-allowed"},null,40,ss),[[ne,v.value]]),t("button",{onClick:X,disabled:!o.value,class:"p-2 text-clay-700/70 hover:text-clay-900 hover:bg-black/5 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:e.$t("profile.chat.attachFile")},[E(u,{name:"lucide:paperclip",class:"w-5 h-5"})],8,ts),t("button",{disabled:!v.value.trim()||!o.value,onClick:T,class:"p-2.5 text-[#BF4E30] hover:bg-[#BF4E30]/10 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95",title:e.$t("common.send")},[E(u,{name:"lucide:send",class:"w-6 h-6 -rotate-45"})],8,as)])])])])])}}};export{cs as default};
