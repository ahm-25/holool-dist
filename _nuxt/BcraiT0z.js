import{a5 as x,K as L,G as H,r as K,O as N,a1 as j}from"./DtlkFUv2.js";import{u as Y}from"./CY06FC8a.js";const R=(s,n="Bearer")=>{if(!s)return null;const f=String(s).trim();if(!f)return null;const h=f.match(/^(Bearer|Token)\s+(.+)$/i);if(h){const S=h[1].toLowerCase()==="bearer"?"Bearer":"Token",E=String(h[2]??"").trim();return E?`${S} ${E}`:null}return`${String(n||"Token").toLowerCase()==="bearer"?"Bearer":"Token"} ${f}`},I=s=>{if(!s)return null;const n=String(s).trim();if(!n)return null;const f=n.match(/^(Bearer|Token)\s+(.+)$/i);return f?String(f[2]??"").trim():n},b=s=>{const n=s==null?void 0:s.key;return typeof n=="string"&&n.toLowerCase()==="unauthenticated"},Q=()=>{const{baseURL:s}=x(),n=L(),f=H(),h=async(l,g={})=>{var m,U,F;const{method:d="GET",body:P,query:z,headers:t={},auth:i=!0,responseType:e="json",parseResponse:r,authScheme:w="Bearer",onRequest:O,onResponse:c,onError:k}=g;try{i&&!n.isAuthenticated&&n.initAuth();const o={Accept:"application/json","Content-Type":"application/json",...t},y=i?n.getToken:null;if(i&&y){const u=R(y,w);u&&(o.Authorization=u)}const A=l.startsWith("http")?l:`${s}${l}`,T={method:d,headers:o,body:P,query:z,responseType:e};r?T.parseResponse=r:e==="json"&&(T.parseResponse=u=>{try{return JSON.parse(u)}catch(C){return console.error("Failed to parse JSON response:",C),u}}),O&&O({options:T}),console.log("Making API request to:",A),console.log("Request options:",{method:T.method,hasAuth:!!o.Authorization,headers:{...o,...o.Authorization?{Authorization:`${String(o.Authorization).split(" ")[0]} ***`}:{}}});let a=await $fetch(A,T);if(e==="json"&&typeof Blob<"u"&&a instanceof Blob){const u=await a.text();try{a=JSON.parse(u)}catch(C){console.error("Failed to parse JSON Blob response:",C),a=u}}if(console.log("API Response received from:",A),console.log("Response:",a),console.log("Response type:",typeof a),i&&y&&e==="json"&&b(a)){const u=I(y),C=[R(y,w),u?R(u,w):null,u?R(u,"Bearer"):null,u?R(u,"Token"):null,u?String(u):null].filter(Boolean),_=new Set,J=C.filter(B=>_.has(B)?!1:(_.add(B),!0));for(let B=0;B<J.length;B++){const v=J[B];if(v===o.Authorization)continue;console.warn(`API returned unauthenticated; retrying with Authorization variant #${B+1}:`,String(v).split(" ")[0],"***");const G={...o,Authorization:v},V={...T,headers:G};if(a=await $fetch(A,V),typeof Blob<"u"&&a instanceof Blob){const M=await a.text();try{a=JSON.parse(M)}catch(W){console.error("Failed to parse JSON Blob response (retry):",W),a=M}}if(!b(a))break}b(a)&&(console.error("API still unauthenticated after retries; clearing auth and redirecting to login."),n.clearAuth(),await N(f("/auth/login")))}if(c&&c({response:a}),(a==null?void 0:a.key)==="fail"||(a==null?void 0:a.status)===!1){const u=(a==null?void 0:a.msg)||(a==null?void 0:a.message)||"Request failed";throw new Error(u)}return a}catch(o){(((m=o==null?void 0:o.response)==null?void 0:m.status)===401||(o==null?void 0:o.statusCode)===401)&&(n.clearAuth(),await N(f("/auth/login"))),k&&k({error:o});const y=((U=o==null?void 0:o.data)==null?void 0:U.msg)||((F=o==null?void 0:o.data)==null?void 0:F.message)||(o==null?void 0:o.message)||"An error occurred";throw console.error("API Error:",y,o),{success:!1,error:y,originalError:o}}};return{api:h,get:(l,g={})=>h(l,{...g,method:"GET"}),post:(l,g,d={})=>h(l,{...d,method:"POST",body:g}),put:(l,g,d={})=>h(l,{...d,method:"PUT",body:g}),patch:(l,g,d={})=>h(l,{...d,method:"PATCH",body:g}),delete:(l,g={})=>h(l,{...g,method:"DELETE"})}},X=(s,n={})=>{const{baseURL:f}=x(),h=L(),p=H(),S=n.auth!==!1,E=n.authScheme||"Bearer",q=n.strictAuth===!0,$=K(E),l=K(0),g=1;let d;const z={...{baseURL:f,key:s,onRequest({options:t}){var r;let i=h.getToken;console.log("â•â•â• useApiFetch - onRequest START â•â•â•"),console.log("Endpoint:",s),console.log("Full URL:",`${f}${s}`),console.log("Has Token:",!!i),console.log("Token (first 20 chars):",i?i.substring(0,20)+"...":"NONE"),console.log("Is Authenticated:",h.isAuthenticated),console.log("User:",((r=h.user)==null?void 0:r.name)||"No user"),console.log("â•â•â• useApiFetch - onRequest END â•â•â•");const e={Accept:"application/json, text/plain, */*"};if(S)if(i){const w=R(i,$.value);w&&(e.Authorization=w,console.log("Authorization header set:",`${String(w).split(" ")[0]} ${String(I(w)).substring(0,20)}...`))}else console.error("âš ï¸ WARNING: No token available for authenticated request!");t.headers=Object.assign({},t.headers,e)},onResponse({response:t}){var i,e;if(console.log("â•â•â• useApiFetch - onResponse START â•â•â•"),console.log("Endpoint:",s),console.log("Status:",t.status),console.log("Response Data:",t._data),console.log("Response Key:",(i=t._data)==null?void 0:i.key),console.log("Response Message:",(e=t._data)==null?void 0:e.msg),console.log("â•â•â• useApiFetch - onResponse END â•â•â•"),(t==null?void 0:t.status)===401)console.error("ðŸš¨ 401 Unauthorized - Clearing auth and redirecting to login"),h.clearAuth(),j(()=>N(p("/auth/login")));else if(b(t._data)){console.warn("âš ï¸ API returned unauthenticated key");const r=t._data;if(!!(r!=null&&r.data||r!=null&&r.orders||r!=null&&r.pagination||r!=null&&r.items||r&&Object.keys(r).length>2)){console.log("âœ… Response has data despite unauthenticated key - treating as successful");return}if(console.warn("No data in response - attempting retry with different auth scheme"),S&&h.getToken&&l.value<g){l.value+=1,$.value=$.value==="Bearer"?"Token":"Bearer",console.warn(`Retrying with auth scheme: ${$.value} (attempt ${l.value}/${g})`),j(()=>{var O;return(O=d==null?void 0:d.refresh)==null?void 0:O.call(d)});return}q&&S?(console.error("ðŸš¨ Unauthenticated after retries - Clearing auth and redirecting to login"),h.clearAuth(),j(()=>N(p("/auth/login")))):console.warn("Authentication failed but strictAuth=false - not redirecting")}},onResponseError({response:t}){var i,e;if(console.error("â•â•â• useApiFetch - onResponseError START â•â•â•"),console.error("Endpoint:",s),console.error("Full URL:",`${f}${s}`),console.error("Status:",t==null?void 0:t.status),console.error("Status Text:",t==null?void 0:t.statusText),console.error("Response Data:",t==null?void 0:t._data),console.error("Response Key:",(i=t==null?void 0:t._data)==null?void 0:i.key),console.error("Response Message:",(e=t==null?void 0:t._data)==null?void 0:e.msg),console.error("â•â•â• useApiFetch - onResponseError END â•â•â•"),(t==null?void 0:t.status)===200&&b(t==null?void 0:t._data)){console.warn("âš ï¸ 200 Response with unauthenticated key in onResponseError - NOT logging out"),console.warn("This means the API returned HTTP 200 but with error data - NOT a genuine auth failure"),console.warn("Your token might be invalid, expired, or in wrong format. Check the onRequest logs above.");return}(t==null?void 0:t.status)===401&&(console.error("ðŸš¨ 401 Unauthorized Error - Clearing auth and redirecting to login"),h.clearAuth(),j(()=>N(p("/auth/login"))))},parseResponse(t){try{return JSON.parse(t)}catch(i){return console.error("Failed to parse JSON response:",i),t}}},...n};return d=Y(s,z,"$Ku-ZEc9A09"),d},tt=()=>{const{baseURL:s}=x(),n=L(),f=H();return{upload:async(p,S,E={})=>{var z,t,i;const{method:q="POST",headers:$={},auth:l=!0,onRequest:g,onResponse:d,onError:P}=E;try{const e={Accept:"application/json, text/plain, */*",...$};if(l&&n.getToken){const k=R(n.getToken,"Bearer");k&&(e.Authorization=k)}const r=p.startsWith("http")?p:`${s}${p}`;g&&g({options:{method:q,headers:e,body:S}});let c=await(await fetch(r,{method:q,headers:e,body:S})).json();if(l&&n.getToken&&b(c)){const k=n.getToken,m=I(k),U="Token",F=[R(k,U),m?R(m,U):null,m?R(m,"Bearer"):null,m?R(m,"Token"):null,m?String(m):null].filter(Boolean),o=new Set,y=F.filter(A=>o.has(A)?!1:(o.add(A),!0));for(let A=0;A<y.length;A++){const T=y[A];if(T===e.Authorization)continue;console.warn(`Upload returned unauthenticated; retrying with Authorization variant #${A+1}:`,String(T).split(" ")[0],"***");const a={...e,Authorization:T};if(c=await(await fetch(r,{method:q,headers:a,body:S})).json(),!b(c))break}b(c)&&(console.error("Upload still unauthenticated after retries; clearing auth and redirecting to login."),n.clearAuth(),await N(f("/auth/login")))}if(d&&d({response:c}),(c==null?void 0:c.key)==="fail"||(c==null?void 0:c.status)===!1){const k=(c==null?void 0:c.msg)||(c==null?void 0:c.message)||"Upload failed";throw new Error(k)}return c}catch(e){(((z=e==null?void 0:e.response)==null?void 0:z.status)===401||(e==null?void 0:e.statusCode)===401)&&(n.clearAuth(),await N(f("/auth/login"))),P&&P({error:e});const r=((t=e==null?void 0:e.data)==null?void 0:t.msg)||((i=e==null?void 0:e.data)==null?void 0:i.message)||(e==null?void 0:e.message)||"Upload failed";throw console.error("Upload Error:",r,e),{success:!1,error:r,originalError:e}}}}};export{Q as a,X as b,tt as u};
