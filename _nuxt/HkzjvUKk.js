import{_ as z}from"./qM6GPxy6.js";import{_ as E}from"./s-ip-wmu.js";import{_ as K,E as U,K as G,G as Q,r as h,k as H,q as J,c as b,a,b as I,L as O,C as c,t as m,F as W,B as X,d as S,M as Y,N as Z,o as w,O as ee,P as te,Q as se,R as ae}from"./B0kbPVzu.js";import{u as oe,a as ne}from"./UsZkeFBk.js";import{u as le}from"./B0CQLlvh.js";import{_ as ie}from"./BFLBms6F.js";import{s as ce}from"./x_rD_Ya3.js";import"./DOS24i9Y.js";import"./D_GyIbDE.js";import"./D1kvvfSo.js";const re=["dir"],ue={class:"w-full md:w-[50%] relative flex flex-col items-center justify-center p-6 md:p-12 z-10 overflow-y-auto"},de={class:"mt-12 md:mt-16 w-full text-center mb-10"},me={class:"hidden md:flex justify-center mb-8"},fe=["src"],pe={class:"flex items-center justify-between"},ve={class:"text-3xl font-bold text-brand-textDark mb-2"},he={class:"text-gray-500 text-sm font-medium"},_e={class:"w-full space-y-6"},ge={class:"flex gap-4 justify-center",dir:"ltr"},ye=["onUpdate:modelValue","onInput","onKeydown"],xe={class:"text-[#3A2A22]/80 text-sm font-semibold text-center"},be=["disabled"],we={key:0,class:"inline-flex items-center justify-center gap-2"},ke={key:1},De={class:"mt-6 text-sm text-[#3A2A22]/70 text-center"},Ae=["disabled"],Le={__name:"otp",setup(Te){const{t:n,locale:j}=U(),i=G(),$=Q(),A=Z(),u=le(),{upload:M}=oe(),{get:N}=ne(),d=h(["","","",""]),g=h([]),y=h(!1),p=h(59);let k=null;const D=h(!1),T=h(!1);H(()=>{var s,e,o;(s=i.initAuth)==null||s.call(i),(o=(e=g.value[0])==null?void 0:e.focus)==null||o.call(e),B()}),J(()=>{L()});function B(){L(),k=ce(()=>{p.value>0?p.value--:L()},1e3)}function L(){k&&clearInterval(k),k=null}const _=h(!1);async function P(){var s;if(!(_.value||p.value>0)){_.value=!0;try{const e=A.query.phone;if(!e){u.error(n("auth.otp.errors.missingPhone","رقم الجوال غير متوفر"));return}const o=await N(`/resend-code?phone=${e}`,{auth:!0});u.success((o==null?void 0:o.msg)||(o==null?void 0:o.message)||n("auth.otp.resendSuccess","تم إعادة إرسال الكود بنجاح")),p.value=59,d.value=["","","",""],(s=g.value[0])==null||s.focus(),B()}catch(e){u.error((e==null?void 0:e.error)||(e==null?void 0:e.message)||n("auth.otp.resendFailed","فشل إعادة إرسال الكود"))}finally{_.value=!1}}}function R(s){var o;const e=d.value[s].replace(/[^0-9]/g,"");d.value[s]=e,e&&s<3&&((o=g.value[s+1])==null||o.focus())}function V(s){var e;!d.value[s]&&s>0&&((e=g.value[s-1])==null||e.focus())}async function q(){var e,o,v;if(y.value)return;const s=d.value.join("").trim();if(s.length!==d.value.length){u.error(n("auth.otp.errors.completeCode","الرجاء إدخال رمز التحقق كاملاً")),C();return}y.value=!0;try{const l=new FormData;l.append("device_type",i.getDeviceType()),l.append("device_id",i.getDeviceId()),l.append("code",s),l.append("activation_code",s),A.query.phone&&l.append("phone",A.query.phone);const t=await M("/activate?_method=patch",l,{method:"POST",auth:!0});u.success((t==null?void 0:t.msg)||(t==null?void 0:t.message)||n("auth.otp.success","تم تفعيل الحساب بنجاح"));const r=((e=t==null?void 0:t.data)==null?void 0:e.token)??(t==null?void 0:t.token)??((o=t==null?void 0:t.data)==null?void 0:o.access_token)??(t==null?void 0:t.access_token),x=typeof r=="string"?r.trim():r,f=((v=t==null?void 0:t.data)==null?void 0:v.user)??(t==null?void 0:t.data)??i.user;x&&i.setAuth(x,f),D.value=!0}catch(l){u.error((l==null?void 0:l.error)||(l==null?void 0:l.message)||n("auth.otp.errors.failed","فشل تفعيل الحساب")),C()}finally{y.value=!1}}async function F({lat:s,lng:e,address:o}){var v,l,t,r,x;D.value=!1,T.value=!0;try{const f=await i.updateProfile({name:(v=i.user)==null?void 0:v.name,email:(l=i.user)==null?void 0:l.email,city_id:((r=(t=i.user)==null?void 0:t.city)==null?void 0:r.id)||((x=i.user)==null?void 0:x.city_id),lat:s,lng:e,map_desc:o});f.success?(u.success(n("auth.location.success","تم حفظ الموقع بنجاح")),await ae($("/"))):u.error(f.error||n("auth.location.failed","فشل حفظ الموقع"))}catch(f){u.error((f==null?void 0:f.message)||n("auth.location.error","حدث خطأ أثناء حفظ الموقع"))}finally{T.value=!1}}function C(){document.querySelectorAll(".otp-box").forEach(e=>{e.classList.add("shake"),setTimeout(()=>e.classList.remove("shake"),350)})}return(s,e)=>{const o=z,v=E;return w(),b("div",{class:"h-screen w-full flex flex-col md:flex-row",dir:c(j)==="ar"?"rtl":"ltr"},[e[3]||(e[3]=a("div",{class:"hidden h-screen md:flex flex-1 radial-gradient-subtle items-center justify-center p-12 relative overflow-hidden"},[a("div",{class:"text-center z-10"},[a("img",{src:O,alt:"logo",class:"w-56 h-48 mx-auto"})])],-1)),a("div",ue,[e[2]||(e[2]=a("div",{class:"mb-8 md:hidden"},[a("img",{src:O,alt:"logo",class:"w-24 h-20"})],-1)),a("div",de,[a("div",me,[a("img",{src:c(ie),alt:"icon",class:"w-24 h-20"},null,8,fe)]),a("div",pe,[a("div",null,[a("h2",ve,m(c(n)("auth.otp.title","كود التحقق")),1),a("p",he,m(c(n)("auth.otp.subtitle","قم بإدخال الكود المرسل على رقم جوالك")),1)]),I(o,{variant:"auth",size:"sm"})])]),a("div",_e,[a("div",ge,[(w(!0),b(W,null,X(d.value,(l,t)=>ee((w(),b("input",{key:t,ref_for:!0,ref_key:"otpRefs",ref:g,"onUpdate:modelValue":r=>d.value[t]=r,maxlength:"1",inputmode:"numeric",class:"otp-box w-14 h-14 rounded-xl border-none bg-[#E9DCD6]/80 text-[#3A2A22] text-2xl font-bold text-center focus:outline-none focus:ring-2 focus:ring-[#B54628]/30 shadow-sm transition-all",onInput:r=>R(t),onKeydown:se(r=>V(t),["backspace"])},null,40,ye)),[[te,d.value[t]]])),128))]),a("div",xe,m(c(n)("auth.otp.remainingTime","الوقت المتبقي"))+" : "+m(p.value)+" "+m(c(n)("common.seconds","ثانية")),1),a("button",{onClick:q,disabled:y.value,class:"w-full !py-4 back-btn transition transform hover:-translate-y-1 mt-4 disabled:opacity-50 disabled:cursor-not-allowed"},[y.value?(w(),b("span",we,[e[1]||(e[1]=a("span",{class:"inline-block w-5 h-5 rounded-full border-2 border-white/40 border-t-white animate-spin"},null,-1)),S(" "+m(c(n)("auth.otp.verifying","جاري التحقق...")),1)])):(w(),b("span",ke,m(c(n)("auth.otp.verify","تحقق")),1))],8,be),a("div",De,[S(m(c(n)("auth.otp.didNotReceive","لم تستلم الرمز؟"))+" ",1),a("button",{onClick:P,disabled:_.value||p.value>0,class:Y(["font-bold hover:underline cursor-pointer mx-1 transition-colors",_.value||p.value>0?"text-gray-400 cursor-not-allowed no-underline":"text-[#B54628]"])},m(_.value?c(n)("common.sending","جاري الإرسال..."):c(n)("auth.otp.resend","إعادة الإرسال")),11,Ae)])])]),I(v,{isOpen:D.value,onClose:e[0]||(e[0]=l=>D.value=!1),onLocationSelected:F},null,8,["isOpen"])],8,re)}}},Re=K(Le,[["__scopeId","data-v-a70792e9"]]);export{Re as default};
