import{al as F,K as j,G as v,N,a1 as U,r as _}from"./C4psxivV.js";import{u as G}from"./D6-jFKJQ.js";const R=(i,t="Bearer")=>{if(!i)return null;const d=String(i).trim();if(!d)return null;const c=d.match(/^(Bearer|Token)\s+(.+)$/i);if(c){const y=c[1].toLowerCase()==="bearer"?"Bearer":"Token",b=String(c[2]??"").trim();return b?`${y} ${b}`:null}return`${String(t||"Token").toLowerCase()==="bearer"?"Bearer":"Token"} ${d}`},x=i=>{if(!i)return null;const t=String(i).trim();if(!t)return null;const d=t.match(/^(Bearer|Token)\s+(.+)$/i);return d?String(d[2]??"").trim():t},T=i=>{const t=i?.key;return typeof t=="string"&&t.toLowerCase()==="unauthenticated"},W=()=>{const{baseURL:i}=F(),t=j(),d=v(),c=async(r,h={})=>{const{method:g="GET",body:q,query:l,headers:e={},auth:s=!0,responseType:k="json",parseResponse:u,authScheme:p="Bearer",onRequest:A,onResponse:z,onError:P}=h;try{s&&!t.isAuthenticated&&t.initAuth();const n={Accept:"application/json","Content-Type":"application/json",...e},m=s?t.getToken:null;if(s&&m){const a=R(m,p);a&&(n.Authorization=a)}const f=r.startsWith("http")?r:`${i}${r}`,S={method:g,headers:n,body:q,query:l,responseType:k};u?S.parseResponse=u:k==="json"&&(S.parseResponse=a=>{try{return JSON.parse(a)}catch(O){return console.error("Failed to parse JSON response:",O),a}}),A&&A({options:S}),console.log("Making API request to:",f),console.log("Request options:",{method:S.method,hasAuth:!!n.Authorization,headers:{...n,...n.Authorization?{Authorization:`${String(n.Authorization).split(" ")[0]} ***`}:{}}});let o=await $fetch(f,S);if(k==="json"&&typeof Blob<"u"&&o instanceof Blob){const a=await o.text();try{o=JSON.parse(a)}catch(O){console.error("Failed to parse JSON Blob response:",O),o=a}}if(console.log("API Response received from:",f),console.log("Response:",o),console.log("Response type:",typeof o),s&&m&&k==="json"&&T(o)){const a=x(m),O=[R(m,p),a?R(a,p):null,a?R(a,"Bearer"):null,a?R(a,"Token"):null,a?String(a):null].filter(Boolean),L=new Set,H=O.filter($=>L.has($)?!1:(L.add($),!0));for(let $=0;$<H.length;$++){const C=H[$];if(C===n.Authorization)continue;console.warn(`API returned unauthenticated; retrying with Authorization variant #${$+1}:`,String(C).split(" ")[0],"***");const D={...n,Authorization:C},J={...S,headers:D};if(o=await $fetch(f,J),typeof Blob<"u"&&o instanceof Blob){const I=await o.text();try{o=JSON.parse(I)}catch(M){console.error("Failed to parse JSON Blob response (retry):",M),o=I}}if(!T(o))break}T(o)&&(console.error("API still unauthenticated after retries; clearing auth and redirecting to login."),t.clearAuth(),await N(d("/auth/login")))}if(z&&z({response:o}),o?.key==="fail"||o?.status===!1){const a=o?.msg||o?.message||"Request failed";throw new Error(a)}return o}catch(n){(n?.response?.status===401||n?.statusCode===401)&&(t.clearAuth(),await N(d("/auth/login"))),P&&P({error:n});const m=n?.data?.msg||n?.data?.message||n?.message||"An error occurred";throw console.error("API Error:",m,n),{success:!1,error:m,originalError:n}}};return{api:c,get:(r,h={})=>c(r,{...h,method:"GET"}),post:(r,h,g={})=>c(r,{...g,method:"POST",body:h}),put:(r,h,g={})=>c(r,{...g,method:"PUT",body:h}),patch:(r,h,g={})=>c(r,{...g,method:"PATCH",body:h}),delete:(r,h={})=>c(r,{...h,method:"DELETE"})}},Q=(i,t={})=>{const{baseURL:d}=F(),c=j(),w=v(),y=t.auth!==!1,b=t.authScheme||"Bearer",B=t.strictAuth===!0,E=_(b),r=_(0),h=1;let g;const l={...{baseURL:d,key:i,onRequest({options:e}){let s=c.getToken;console.log("â•â•â• useApiFetch - onRequest START â•â•â•"),console.log("Endpoint:",i),console.log("Full URL:",`${d}${i}`),console.log("Has Token:",!!s),console.log("Token (first 20 chars):",s?s.substring(0,20)+"...":"NONE"),console.log("Is Authenticated:",c.isAuthenticated),console.log("User:",c.user?.name||"No user"),console.log("â•â•â• useApiFetch - onRequest END â•â•â•");const k={Accept:"application/json, text/plain, */*"};if(y)if(s){const u=R(s,E.value);u&&(k.Authorization=u,console.log("Authorization header set:",`${String(u).split(" ")[0]} ${String(x(u)).substring(0,20)}...`))}else console.error("âš ï¸ WARNING: No token available for authenticated request!");e.headers=Object.assign({},e.headers,k)},onResponse({response:e}){if(console.log("â•â•â• useApiFetch - onResponse START â•â•â•"),console.log("Endpoint:",i),console.log("Status:",e.status),console.log("Response Data:",e._data),console.log("Response Key:",e._data?.key),console.log("Response Message:",e._data?.msg),console.log("â•â•â• useApiFetch - onResponse END â•â•â•"),e?.status===401)console.error("ðŸš¨ 401 Unauthorized - Clearing auth and redirecting to login"),c.clearAuth(),U(()=>N(w("/auth/login")));else if(T(e._data)){console.warn("âš ï¸ API returned unauthenticated key");const s=e._data;if(!!(s?.data||s?.orders||s?.pagination||s?.items||s&&Object.keys(s).length>2)){console.log("âœ… Response has data despite unauthenticated key - treating as successful");return}if(console.warn("No data in response - attempting retry with different auth scheme"),y&&c.getToken&&r.value<h){r.value+=1,E.value=E.value==="Bearer"?"Token":"Bearer",console.warn(`Retrying with auth scheme: ${E.value} (attempt ${r.value}/${h})`),U(()=>g?.refresh?.());return}B&&y?(console.error("ðŸš¨ Unauthenticated after retries - Clearing auth and redirecting to login"),c.clearAuth(),U(()=>N(w("/auth/login")))):console.warn("Authentication failed but strictAuth=false - not redirecting")}},onResponseError({response:e}){if(console.error("â•â•â• useApiFetch - onResponseError START â•â•â•"),console.error("Endpoint:",i),console.error("Full URL:",`${d}${i}`),console.error("Status:",e?.status),console.error("Status Text:",e?.statusText),console.error("Response Data:",e?._data),console.error("Response Key:",e?._data?.key),console.error("Response Message:",e?._data?.msg),console.error("â•â•â• useApiFetch - onResponseError END â•â•â•"),e?.status===200&&T(e?._data)){console.warn("âš ï¸ 200 Response with unauthenticated key in onResponseError - NOT logging out"),console.warn("This means the API returned HTTP 200 but with error data - NOT a genuine auth failure"),console.warn("Your token might be invalid, expired, or in wrong format. Check the onRequest logs above.");return}e?.status===401&&(console.error("ðŸš¨ 401 Unauthorized Error - Clearing auth and redirecting to login"),c.clearAuth(),U(()=>N(w("/auth/login"))))},parseResponse(e){try{return JSON.parse(e)}catch(s){return console.error("Failed to parse JSON response:",s),e}}},...t};return g=G(i,l,"$xQy7uMaLhq"),g},Y=()=>{const{baseURL:i}=F(),t=j(),d=v();return{upload:async(w,y,b={})=>{const{method:B="POST",headers:E={},auth:r=!0,onRequest:h,onResponse:g,onError:q}=b;try{const l={Accept:"application/json, text/plain, */*",...E};if(r&&t.getToken){const p=R(t.getToken,"Bearer");p&&(l.Authorization=p)}const e=w.startsWith("http")?w:`${i}${w}`;h&&h({options:{method:B,headers:l,body:y}});let u=await(await fetch(e,{method:B,headers:l,body:y})).json();if(r&&t.getToken&&T(u)){const p=t.getToken,A=x(p),z="Token",P=[R(p,z),A?R(A,z):null,A?R(A,"Bearer"):null,A?R(A,"Token"):null,A?String(A):null].filter(Boolean),n=new Set,m=P.filter(f=>n.has(f)?!1:(n.add(f),!0));for(let f=0;f<m.length;f++){const S=m[f];if(S===l.Authorization)continue;console.warn(`Upload returned unauthenticated; retrying with Authorization variant #${f+1}:`,String(S).split(" ")[0],"***");const o={...l,Authorization:S};if(u=await(await fetch(e,{method:B,headers:o,body:y})).json(),!T(u))break}T(u)&&(console.error("Upload still unauthenticated after retries; clearing auth and redirecting to login."),t.clearAuth(),await N(d("/auth/login")))}if(g&&g({response:u}),u?.key==="fail"||u?.status===!1){const p=u?.msg||u?.message||"Upload failed";throw new Error(p)}return u}catch(l){(l?.response?.status===401||l?.statusCode===401)&&(t.clearAuth(),await N(d("/auth/login"))),q&&q({error:l});const e=l?.data?.msg||l?.data?.message||l?.message||"Upload failed";throw console.error("Upload Error:",e,l),{success:!1,error:e,originalError:l}}}}};export{W as a,Q as b,Y as u};
