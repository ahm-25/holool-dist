import G from"./BRDfM9Cj.js";import{o as i,c,a as s,J as $,t as f,M as S,v as X,F as U,B as V,b as R,K as Y,E as Z,g as ee,n as se,A as T,P as te,Q as ae,R as re,S as oe,O as le,r as m,m as k,a1 as ne}from"./CPAe5scI.js";import{a as ie,u as ce}from"./DG626kXz.js";import{u as de}from"./C0TKYP46.js";import"./DqsQrZ2N.js";const ue={key:0,class:"flex-shrink-0"},me=["src"],fe={key:0,class:"mb-3 overflow-hidden rounded-xl"},he=["src"],ve={key:1,class:"text-sm md:text-base leading-relaxed font-medium"},pe={__name:"MessageBubble",props:{message:{type:Object,required:!0},senderAvatar:{type:String,default:""}},setup(n){return(v,b)=>(i(),c("div",{class:S(["flex w-full mb-4 items-end gap-2",n.message.isMe?"justify-end":"justify-start"])},[n.message.isMe?$("",!0):(i(),c("div",ue,[s("img",{src:n.senderAvatar,class:"w-8 h-8 rounded-full object-cover border border-white/30 shadow-sm",alt:"Sender"},null,8,me)])),s("div",{class:S(["relative max-w-[75%] md:max-w-[60%] px-5 py-3 shadow-sm",n.message.isMe?"bg-[#8f8f8f] text-white rounded-2xl rounded-bl-none":"bg-[#e6dcd5]/80 backdrop-blur-sm text-clay-900 rounded-2xl rounded-br-none"])},[n.message.imageUrl?(i(),c("div",fe,[s("img",{src:n.message.imageUrl,class:"w-full h-auto object-cover max-h-64"},null,8,he)])):$("",!0),n.message.text?(i(),c("p",ve,f(n.message.text),1)):$("",!0)],2)],2))}},ge=["src","alt"],K={__name:"Avatar",props:{src:String,alt:String,size:{type:String,default:"md"},className:{type:String,default:""}},setup(n){const v=X({sm:"w-10 h-10",md:"w-12 h-12",lg:"w-14 h-14"});return(b,d)=>(i(),c("div",{class:S(["relative inline-block",v[n.size],n.className])},[s("img",{src:n.src,alt:n.alt,class:"w-full h-full rounded-full object-cover border-2 border-clay-100/50 shadow-sm"},null,8,ge)],2))}},ye={class:"flex flex-col gap-3 overflow-y-auto pr-2 pb-2 h-full"},be=["onClick"],_e={class:"flex w-full items-center gap-3"},xe={class:"flex flex-col items-start flex-1 min-w-0"},we={class:"font-bold text-clay-900 truncate text-right w-full text-base"},Ae={class:"text-xs text-clay-700/80 truncate text-right w-full font-medium mt-0.5"},Me={__name:"ChatList",props:{users:Array,activeUserId:String,onSelectUser:Function},setup(n){return(v,b)=>(i(),c("div",ye,[(i(!0),c(U,null,V(n.users,d=>(i(),c("button",{key:d.id,onClick:()=>n.onSelectUser(d.id),class:S(["group flex items-center p-3 rounded-2xl transition-all duration-200 border",d.id===n.activeUserId?"bg-clay-200/80 shadow-inner border-clay-400/30":"bg-clay-100/30 hover:bg-clay-100/50 border-transparent hover:border-white/20"])},[s("div",_e,[R(K,{src:d.avatar,alt:d.name,size:"md"},null,8,["src","alt"]),s("div",xe,[s("span",we,f(d.name),1),s("span",Ae,f(d.lastMessage||"Click to chat"),1)])])],10,be))),128))]))}},ke=()=>{const{get:n}=ie(),{upload:v}=ce(),b=async()=>{try{return await n("/get-rooms")}catch(o){throw console.error("Error fetching rooms:",o),o}},d=async o=>{try{return await n(`/room-members/${o}`)}catch(r){throw console.error("Error fetching room members:",r),r}},w=async o=>{try{return await n(`/get-room-messages/${o}`)}catch(r){throw console.error("Error fetching room messages:",r),r}},y=async(o,r)=>{try{const l=new FormData;return l.append("message",r),await v(`/send-message/${o}`,l)}catch(l){throw console.error("Error sending message:",l),l}},A=async(o,r)=>{try{const l=new FormData;return l.append("file",r),await v(`/upload-room-file/${o}`,l)}catch(l){throw console.error("Error uploading file:",l),l}};return{getRooms:b,getRoomMembers:d,getRoomMessages:w,sendMessage:y,uploadRoomFile:A,sendMessageWithFile:async(o,r,l)=>{try{const g=await A(o,l),h=await y(o,r);return{file:g,message:h}}catch(g){throw console.error("Error sending message with file:",g),g}}}},$e={class:"min-h-screen h-screen p-4 md:p-6 flex items-center justify-center bg-[#d4beb1]",dir:"rtl"},Re={class:"w-full max-w-[1400px] h-full max-h-[850px] grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-6"},Se={class:"hidden lg:flex flex-col bg-clay-200/20 backdrop-blur-md border border-white/20 rounded-[2rem] shadow-sm p-4 h-full overflow-hidden"},Ee={key:0,class:"flex items-center justify-center h-full"},Ie={class:"text-clay-700"},Ue={key:1,class:"flex items-center justify-center h-full"},Ce={class:"text-clay-700 text-center"},Fe={class:"relative bg-clay-200/20 backdrop-blur-md border border-white/20 rounded-[2rem] shadow-sm flex flex-col overflow-hidden"},je={class:"p-6 flex items-center z-10 border-b border-white/10"},De={key:0,class:"flex items-center gap-3"},Be={class:"text-right"},ze={class:"text-xl font-bold text-clay-900"},Ne={key:1,class:"flex items-center gap-3"},Te={class:"text-right"},Ve={class:"text-xl font-bold text-clay-900"},Ke={class:"flex-1 overflow-y-auto p-4 md:p-8 space-y-2 custom-scrollbar"},qe={key:0,class:"flex items-center justify-center h-full"},Oe={class:"text-clay-700"},Le={key:1,class:"flex items-center justify-center h-full"},Pe={class:"text-clay-700 text-center"},We={key:2,class:"flex items-center justify-center h-full"},He={class:"text-clay-700 text-center"},Je={class:"text-sm mt-2"},Qe={key:0,class:"flex w-full justify-start mb-4 px-12"},Ge={class:"p-4 md:p-6 pt-2"},Xe={class:"bg-clay-100/40 backdrop-blur-xl rounded-2xl p-2 px-3 flex items-center gap-3 shadow-sm border border-white/30"},Ye=["onKeydown","placeholder","disabled"],Ze=["disabled","title"],es=["disabled","title"],ls={__name:"index",setup(n){const{getRooms:v,getRoomMessages:b,sendMessage:d}=ke(),w=Y(),y=de(),A=le(),{t:p}=Z(),o=m([]),r=m(null),l=m([]),g=m([]),h=m(""),q=m(!1),C=m(null),E=m(!1),I=m(!1),F=m(null),O=m(null),M=k(()=>!Array.isArray(o.value)||o.value.length===0?null:o.value.find(e=>e.id==r.value)||o.value[0]),_=k(()=>M.value?{id:M.value.id,name:M.value.name,avatar:M.value.avatar}:null),j=k(()=>Array.isArray(o.value)?o.value:[]),D=k(()=>l.value.map(e=>({id:e.id,senderId:e.sender_id||e.user_id||e.senderId,text:e.body||e.message||e.text||"",timestamp:e.created_dt||e.created_at||"",imageUrl:e.image_url||e.imageUrl,isMe:e.isMe||e.is_sender===1||e.is_sender===!0})));ee(async()=>{await L();const e=A.query.roomId;if(e){const t=o.value.find(a=>a.id==e);t?r.value=t.id:r.value=Number(e)||e}else o.value.length>0&&(r.value=o.value[0].id);r.value&&await B(r.value)});const L=async()=>{try{E.value=!0;const e=await v();console.log("API Response for getRooms:",e),console.log("Response type:",typeof e),console.log("Is Array:",Array.isArray(e));let t=[];Array.isArray(e)?t=e:e?.data?.data&&Array.isArray(e.data.data)?t=e.data.data:e?.data&&Array.isArray(e.data)?t=e.data:e?.rooms&&Array.isArray(e.rooms)&&(t=e.rooms),o.value=t.map(a=>{if(a.providerable)return{id:a.providerable.room_id||a.id,originalId:a.id,name:a.providerable.name||p("profile.chat.user"),avatar:a.providerable.image||"https://picsum.photos/id/64/200",lastMessage:a.notes||a.status_text||p("profile.chat.noMessages"),members:[{id:"other",name:a.providerable.name,avatar:a.providerable.image}],...a};const u=w.user?.id,x=a.members||[],N=x.find(Q=>Q.id!==u)||x[0];return{id:a.id,name:a.name||N?.name||p("profile.chat.title"),avatar:a.avatar||N?.image||"https://picsum.photos/id/64/200",lastMessage:a.last_message_body||a.last_message?.text||a.lastMessage||"",lastMessageTime:a.last_message_created_dt||"",members:x,...a}}),console.log("Rooms set to:",o.value),console.log("Rooms count:",o.value.length)}catch(e){console.error("Error fetching rooms:",e),y.error(p("profile.chat.loadError")),o.value=[]}finally{E.value=!1}},B=async e=>{if(e)try{I.value=!0;const t=await b(e);t?.data?.members&&Array.isArray(t.data.members)&&(g.value=t.data.members),t?.data?.messages?.data&&Array.isArray(t.data.messages.data)?l.value=t.data.messages.data.slice().reverse():Array.isArray(t?.data)?l.value=t.data.slice().reverse():Array.isArray(t)?l.value=t.slice().reverse():l.value=[]}catch(t){console.error("Error fetching messages:",t),y.error(p("profile.chat.loadMessagesError")),l.value=[]}finally{I.value=!1}},P=async e=>{r.value!==e&&(r.value=e,await B(e))},W=()=>{h.value.trim()&&z()},z=async()=>{if(!h.value.trim()||!r.value)return;const e=h.value,t={id:"temp-"+Date.now(),user_id:w.user?.id,message:e,created_at:new Date().toISOString(),isMe:!0};l.value.push(t),h.value="";try{const a=await d(r.value,e);if(a?.data?.id){const u=l.value.findIndex(x=>x.id===t.id);u!==-1&&l.value.splice(u,1,a.data)}}catch(a){console.error("Error sending message:",a),y.error(p("profile.chat.sendError")),l.value=l.value.filter(u=>u.id!==t.id)}},H=e=>{const t=e.target.files[0];t&&(O.value=t,y.success(`${p("profile.chat.fileSelected")}${t.name}`))},J=()=>{F.value?.click()};return se(l,()=>{ne(()=>{C.value?.scrollIntoView({behavior:"smooth"})})},{deep:!0}),(e,t)=>{const a=G;return i(),c("div",$e,[s("div",Re,[s("div",Se,[E.value?(i(),c("div",Ee,[s("div",Ie,f(e.$t("common.loading")),1)])):j.value.length===0?(i(),c("div",Ue,[s("div",Ce,[s("p",null,f(e.$t("profile.chat.noChats")),1)])])):(i(),T(Me,{key:2,users:j.value,activeUserId:r.value,onSelectUser:P},null,8,["users","activeUserId"]))]),s("div",Fe,[s("div",je,[_.value?(i(),c("div",De,[R(K,{src:_.value.avatar,alt:_.value.name,size:"lg"},null,8,["src","alt"]),s("div",Be,[s("h2",ze,f(_.value.name),1)])])):(i(),c("div",Ne,[s("div",Te,[s("h2",Ve,f(e.$t("profile.chat.title")),1)])]))]),s("div",Ke,[I.value?(i(),c("div",qe,[s("div",Oe,f(e.$t("profile.chat.loadingMessages")),1)])):r.value?D.value.length===0?(i(),c("div",We,[s("div",He,[s("p",null,f(e.$t("profile.chat.noMessages")),1),s("p",Je,f(e.$t("profile.chat.startConversation")),1)])])):(i(),c(U,{key:3},[(i(!0),c(U,null,V(D.value,u=>(i(),T(pe,{key:u.id,message:u,senderAvatar:_.value?.avatar||"https://picsum.photos/id/64/200"},null,8,["message","senderAvatar"]))),128)),q.value?(i(),c("div",Qe,[...t[1]||(t[1]=[s("div",{class:"bg-[#e6dcd5]/80 text-clay-900 rounded-2xl p-3 shadow-sm flex items-center gap-1"},[s("span",{class:"w-1.5 h-1.5 bg-clay-800/40 rounded-full animate-bounce"}),s("span",{class:"w-1.5 h-1.5 bg-clay-800/40 rounded-full animate-bounce delay-75"}),s("span",{class:"w-1.5 h-1.5 bg-clay-800/40 rounded-full animate-bounce delay-150"})],-1)])])):$("",!0)],64)):(i(),c("div",Le,[s("div",Pe,[s("p",null,f(e.$t("profile.chat.selectConversation")),1)])])),s("div",{ref_key:"messagesEndRef",ref:C},null,512)]),s("div",Ge,[s("input",{ref_key:"fileInput",ref:F,type:"file",class:"hidden",onChange:H,accept:"image/*,video/*,.pdf,.doc,.docx"},null,544),s("div",Xe,[te(s("input",{"onUpdate:modelValue":t[0]||(t[0]=u=>h.value=u),onKeydown:re(oe(W,["prevent"]),["enter"]),placeholder:e.$t("profile.chat.typeHere"),disabled:!r.value,class:"flex-1 bg-transparent border-none outline-none px-4 text-clay-900 placeholder-clay-700/50 text-right font-medium disabled:opacity-50 disabled:cursor-not-allowed"},null,40,Ye),[[ae,h.value]]),s("button",{onClick:J,disabled:!r.value,class:"p-2 text-clay-700/70 hover:text-clay-900 hover:bg-black/5 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:e.$t("profile.chat.attachFile")},[R(a,{name:"lucide:paperclip",class:"w-5 h-5"})],8,Ze),s("button",{disabled:!h.value.trim()||!r.value,onClick:z,class:"p-2.5 text-[#BF4E30] hover:bg-[#BF4E30]/10 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95",title:e.$t("common.send")},[R(a,{name:"lucide:send",class:"w-6 h-6 -rotate-45"})],8,es)])])])])])}}};export{ls as default};
