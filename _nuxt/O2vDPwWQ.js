import X from"./DQZoulF6.js";import{c as d,o as c,J as $,a as t,t as f,M as I,v as Y,F as C,B as O,b as R,K as Z,E as ee,r as v,g as A,k as se,N as te,n as ae,A as K,O as re,P as oe,Q as le,S as ne,a1 as ce}from"./B5HeACpe.js";import{a as ie,u as de}from"./CEwE9Az9.js";import{u as ue}from"./zDzW9YfH.js";import"./P9Gc60wC.js";const me={key:0,class:"flex-shrink-0"},fe=["src"],he={key:0,class:"mb-3 overflow-hidden rounded-xl"},ve=["src"],ge={key:1,class:"text-sm md:text-base leading-relaxed font-medium"},pe={__name:"MessageBubble",props:{message:{type:Object,required:!0},senderAvatar:{type:String,default:""}},setup(l){return(g,b)=>(c(),d("div",{class:I(["flex w-full mb-4 items-end gap-2",l.message.isMe?"justify-end":"justify-start"])},[l.message.isMe?$("",!0):(c(),d("div",me,[t("img",{src:l.senderAvatar,class:"w-8 h-8 rounded-full object-cover border border-white/30 shadow-sm",alt:"Sender"},null,8,fe)])),t("div",{class:I(["relative max-w-[75%] md:max-w-[60%] px-5 py-3 shadow-sm",l.message.isMe?"bg-[#8f8f8f] text-white rounded-2xl rounded-bl-none":"bg-[#e6dcd5]/80 backdrop-blur-sm text-clay-900 rounded-2xl rounded-br-none"])},[l.message.imageUrl?(c(),d("div",he,[t("img",{src:l.message.imageUrl,class:"w-full h-auto object-cover max-h-64"},null,8,ve)])):$("",!0),l.message.text?(c(),d("p",ge,f(l.message.text),1)):$("",!0)],2)],2))}},ye=["src","alt"],q={__name:"Avatar",props:{src:String,alt:String,size:{type:String,default:"md"},className:{type:String,default:""}},setup(l){const g=Y({sm:"w-10 h-10",md:"w-12 h-12",lg:"w-14 h-14"});return(b,m)=>(c(),d("div",{class:I(["relative inline-block",g[l.size],l.className])},[t("img",{src:l.src,alt:l.alt,class:"w-full h-full rounded-full object-cover border-2 border-clay-100/50 shadow-sm"},null,8,ye)],2))}},be={class:"flex flex-col gap-3 overflow-y-auto pr-2 pb-2 h-full"},xe=["onClick"],_e={class:"flex w-full items-center gap-3"},we={class:"flex flex-col items-start flex-1 min-w-0"},ke={class:"font-bold text-clay-900 truncate text-right w-full text-base"},Me={class:"text-xs text-clay-700/80 truncate text-right w-full font-medium mt-0.5"},Ae={__name:"ChatList",props:{users:Array,activeUserId:String,onSelectUser:Function},setup(l){return(g,b)=>(c(),d("div",be,[(c(!0),d(C,null,O(l.users,m=>(c(),d("button",{key:m.id,onClick:()=>l.onSelectUser(m.id),class:I(["group flex items-center p-3 rounded-2xl transition-all duration-200 border",m.id===l.activeUserId?"bg-clay-200/80 shadow-inner border-clay-400/30":"bg-clay-100/30 hover:bg-clay-100/50 border-transparent hover:border-white/20"])},[t("div",_e,[R(q,{src:m.avatar,alt:m.name,size:"md"},null,8,["src","alt"]),t("div",we,[t("span",ke,f(m.name),1),t("span",Me,f(m.lastMessage||"Click to chat"),1)])])],10,xe))),128))]))}},$e=()=>{const{get:l}=ie(),{upload:g}=de(),b=async()=>{try{return await l("/get-rooms")}catch(o){throw console.error("Error fetching rooms:",o),o}},m=async o=>{try{return await l(`/room-members/${o}`)}catch(r){throw console.error("Error fetching room members:",r),r}},_=async o=>{try{return await l(`/get-room-messages/${o}`)}catch(r){throw console.error("Error fetching room messages:",r),r}},y=async(o,r)=>{try{const n=new FormData;return n.append("message",r),await g(`/send-message/${o}`,n)}catch(n){throw console.error("Error sending message:",n),n}},k=async o=>{try{const r=new FormData;return r.append("file",o),await g("/upload-room-file",r)}catch(r){throw console.error("Error uploading file:",r),r}};return{getRooms:b,getRoomMembers:m,getRoomMessages:_,sendMessage:y,uploadRoomFile:k,sendMessageWithFile:async(o,r,n)=>{try{const u=await k(n),S=await y(o,r);return{file:u,message:S}}catch(u){throw console.error("Error sending message with file:",u),u}}}},Re={class:"min-h-screen h-screen p-4 md:p-6 flex items-center justify-center bg-[#d4beb1]",dir:"rtl"},Ie={class:"w-full max-w-[1400px] h-full max-h-[850px] grid grid-cols-1 lg:grid-cols-[350px_1fr] gap-6"},Se={class:"hidden lg:flex flex-col bg-clay-200/20 backdrop-blur-md border border-white/20 rounded-[2rem] shadow-sm p-4 h-full overflow-hidden"},Ee={key:0,class:"flex items-center justify-center h-full"},je={class:"text-clay-700"},Ce={key:1,class:"flex items-center justify-center h-full"},Fe={class:"text-clay-700 text-center"},Ue={class:"relative bg-clay-200/20 backdrop-blur-md border border-white/20 rounded-[2rem] shadow-sm flex flex-col overflow-hidden"},De={class:"p-6 flex items-center z-10 border-b border-white/10"},Be={key:0,class:"flex items-center gap-3"},ze={class:"text-right"},Ne={class:"text-xl font-bold text-clay-900"},Ve={key:1,class:"flex items-center gap-3"},Te={class:"text-right"},Ke={class:"text-xl font-bold text-clay-900"},Oe={class:"flex-1 overflow-y-auto p-4 md:p-8 space-y-2 custom-scrollbar"},qe={key:0,class:"flex items-center justify-center h-full"},Le={class:"text-clay-700"},Pe={key:1,class:"flex items-center justify-center h-full"},We={class:"text-clay-700 text-center"},He={key:2,class:"flex items-center justify-center h-full"},Je={class:"text-clay-700 text-center"},Qe={class:"text-sm mt-2"},Ge={key:0,class:"flex w-full justify-start mb-4 px-12"},Xe={class:"p-4 md:p-6 pt-2"},Ye={class:"bg-clay-100/40 backdrop-blur-xl rounded-2xl p-2 px-3 flex items-center gap-3 shadow-sm border border-white/30"},Ze=["onKeydown","placeholder","disabled"],es=["disabled","title"],ss=["disabled","title"],ns={__name:"index",setup(l){const{getRooms:g,getRoomMessages:b,sendMessage:m}=$e(),_=Z(),y=ue(),k=te(),{t:p}=ee(),o=v([]),r=v(null),n=v([]),u=v(""),S=v(!1),F=v(null),E=v(!1),j=v(!1),U=v(null),L=v(null),M=A(()=>!Array.isArray(o.value)||o.value.length===0?null:o.value.find(e=>e.id===r.value)||o.value[0]),w=A(()=>M.value?{id:M.value.id,name:M.value.name,avatar:M.value.avatar}:null),D=A(()=>Array.isArray(o.value)?o.value:[]),B=A(()=>{var a;const e=(a=_.user)==null?void 0:a.id;return n.value.map(s=>({id:s.id,senderId:s.user_id||s.senderId,text:s.message||s.text||"",timestamp:s.created_at?new Date(s.created_at):new Date,imageUrl:s.image_url||s.imageUrl,isMe:(s.user_id||s.senderId)==e}))});se(async()=>{await P();const e=k.query.roomId;if(e){const a=o.value.find(s=>s.id==e);a?r.value=a.id:o.value.length>0&&(r.value=o.value[0].id)}else o.value.length>0&&(r.value=o.value[0].id);r.value&&await z(r.value)});const P=async()=>{try{E.value=!0;const e=await g();console.log("API Response for getRooms:",e),console.log("Response type:",typeof e),console.log("Is Array:",Array.isArray(e));let a=[];if(Array.isArray(e))a=e;else if(e!=null&&e.data&&Array.isArray(e.data))a=e.data;else if(e!=null&&e.rooms&&Array.isArray(e.rooms))a=e.rooms;else if(e!=null&&e.data&&typeof e.data=="object")a=[e.data];else if(typeof e=="object"&&e!==null){const s=Object.values(e).filter(i=>Array.isArray(i));s.length>0&&(a=s[0])}o.value=a.map(s=>{var V,T;if(s.providerable)return{id:s.providerable.room_id||s.id,originalId:s.id,name:s.providerable.name||p("profile.chat.user"),avatar:s.providerable.image||"https://picsum.photos/id/64/200",lastMessage:s.notes||s.status_text||p("profile.chat.noMessages"),members:[{id:"other",name:s.providerable.name,avatar:s.providerable.image}],...s};const i=(V=_.user)==null?void 0:V.id,h=s.members||[],x=h.find(G=>G.id!==i)||h[0];return{id:s.id,name:s.name||(x==null?void 0:x.name)||p("profile.chat.title"),avatar:s.avatar||(x==null?void 0:x.avatar)||"https://picsum.photos/id/64/200",lastMessage:((T=s.last_message)==null?void 0:T.text)||s.lastMessage||"",members:h,...s}}),console.log("Rooms set to:",o.value),console.log("Rooms count:",o.value.length)}catch(e){console.error("Error fetching rooms:",e),y.error(p("profile.chat.loadError")),o.value=[]}finally{E.value=!1}},z=async e=>{if(e)try{j.value=!0;const a=await b(e);a!=null&&a.data?n.value=a.data:Array.isArray(a)?n.value=a:n.value=[]}catch(a){console.error("Error fetching messages:",a),y.error(p("profile.chat.loadMessagesError")),n.value=[]}finally{j.value=!1}},W=async e=>{r.value!==e&&(r.value=e,await z(e))},H=()=>{u.value.trim()&&N()},N=async()=>{var s;if(!u.value.trim()||!r.value)return;const e=u.value,a={id:"temp-"+Date.now(),user_id:(s=_.user)==null?void 0:s.id,message:e,created_at:new Date().toISOString(),isMe:!0};n.value.push(a),u.value="";try{const i=await m(r.value,e);n.value=n.value.filter(h=>h.id!==a.id),i!=null&&i.data?n.value.push(i.data):i!=null&&i.message&&n.value.push({...a,id:i.id||a.id,...i})}catch(i){console.error("Error sending message:",i),y.error(p("profile.chat.sendError")),n.value=n.value.filter(h=>h.id!==a.id)}},J=e=>{const a=e.target.files[0];a&&(L.value=a,y.success(`${p("profile.chat.fileSelected")}${a.name}`))},Q=()=>{var e;(e=U.value)==null||e.click()};return ae(n,()=>{ce(()=>{var e;(e=F.value)==null||e.scrollIntoView({behavior:"smooth"})})},{deep:!0}),(e,a)=>{const s=X;return c(),d("div",Re,[t("div",Ie,[t("div",Se,[E.value?(c(),d("div",Ee,[t("div",je,f(e.$t("common.loading")),1)])):D.value.length===0?(c(),d("div",Ce,[t("div",Fe,[t("p",null,f(e.$t("profile.chat.noChats")),1)])])):(c(),K(Ae,{key:2,users:D.value,activeUserId:r.value,onSelectUser:W},null,8,["users","activeUserId"]))]),t("div",Ue,[t("div",De,[w.value?(c(),d("div",Be,[R(q,{src:w.value.avatar,alt:w.value.name,size:"lg"},null,8,["src","alt"]),t("div",ze,[t("h2",Ne,f(w.value.name),1)])])):(c(),d("div",Ve,[t("div",Te,[t("h2",Ke,f(e.$t("profile.chat.title")),1)])]))]),t("div",Oe,[j.value?(c(),d("div",qe,[t("div",Le,f(e.$t("profile.chat.loadingMessages")),1)])):r.value?B.value.length===0?(c(),d("div",He,[t("div",Je,[t("p",null,f(e.$t("profile.chat.noMessages")),1),t("p",Qe,f(e.$t("profile.chat.startConversation")),1)])])):(c(),d(C,{key:3},[(c(!0),d(C,null,O(B.value,i=>{var h;return c(),K(pe,{key:i.id,message:i,senderAvatar:((h=w.value)==null?void 0:h.avatar)||"https://picsum.photos/id/64/200"},null,8,["message","senderAvatar"])}),128)),S.value?(c(),d("div",Ge,a[1]||(a[1]=[t("div",{class:"bg-[#e6dcd5]/80 text-clay-900 rounded-2xl p-3 shadow-sm flex items-center gap-1"},[t("span",{class:"w-1.5 h-1.5 bg-clay-800/40 rounded-full animate-bounce"}),t("span",{class:"w-1.5 h-1.5 bg-clay-800/40 rounded-full animate-bounce delay-75"}),t("span",{class:"w-1.5 h-1.5 bg-clay-800/40 rounded-full animate-bounce delay-150"})],-1)]))):$("",!0)],64)):(c(),d("div",Pe,[t("div",We,[t("p",null,f(e.$t("profile.chat.selectConversation")),1)])])),t("div",{ref_key:"messagesEndRef",ref:F},null,512)]),t("div",Xe,[t("input",{ref_key:"fileInput",ref:U,type:"file",class:"hidden",onChange:J,accept:"image/*,video/*,.pdf,.doc,.docx"},null,544),t("div",Ye,[re(t("input",{"onUpdate:modelValue":a[0]||(a[0]=i=>u.value=i),onKeydown:le(ne(H,["prevent"]),["enter"]),placeholder:e.$t("profile.chat.typeHere"),disabled:!r.value,class:"flex-1 bg-transparent border-none outline-none px-4 text-clay-900 placeholder-clay-700/50 text-right font-medium disabled:opacity-50 disabled:cursor-not-allowed"},null,40,Ze),[[oe,u.value]]),t("button",{onClick:Q,disabled:!r.value,class:"p-2 text-clay-700/70 hover:text-clay-900 hover:bg-black/5 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:e.$t("profile.chat.attachFile")},[R(s,{name:"lucide:paperclip",class:"w-5 h-5"})],8,es),t("button",{disabled:!u.value.trim()||!r.value,onClick:N,class:"p-2.5 text-[#BF4E30] hover:bg-[#BF4E30]/10 rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95",title:e.$t("common.send")},[R(s,{name:"lucide:send",class:"w-6 h-6 -rotate-45"})],8,ss)])])])])])}}};export{ns as default};
